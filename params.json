{"name":"Test　Twilio_Zabbix","tagline":"Test　Use Twilio in Zabbix","body":"# 概要\r\n***\r\nZabbixと連携して、指定した連絡先に電話を掛けるものになります。\r\nこれにより、Zabbixで障害を検知したら、自動で担当者へ障害が発生したことを電話で伝える事が可能になります。\r\n\r\n## 使用するファイル\r\n|ファイル名|説明|\r\n|---|---|\r\n|call-request.php|パラメータのチェックとtwilio_call関数（コール処理を実行する関数）へ引数を渡す処理を行う|\r\n|call-function.php|コール処理とログ出力処理を行う関数が定義されている|\r\n|twilio_zabbix.php|必要なパラメータが設定されている|\r\n|calllog.log|ログ出力先ファイル。ログの出力形式については、表下に記載する。|\r\n|Serviceディレクトリ|Twilio API library(PHP)のディレクトリ。 公式ページからダウンロードする。 [Twilio API Library(PHP)](https://github.com/twilio/twilio-php/archive/latest.zip)|\r\n\r\n## ファイル説明\r\n### call-request.php\r\ncall-request.phpは、渡された引数とtwilio_zabbix.phpのパラメータの確認を行った後に、コール処理を行う関数を実行します。  \r\n引数などの確認で問題があった場合は、以下のエラー番号を返します。\r\n\r\n|エラー番号|エラー内容|\r\n|---|---|\r\n|1|call-request.phpに渡された引数の数に誤りがある|\r\n|2|call-request.phpに渡された第一引数のグループ名が$CALL_GROUP_ARRAYに存在しない|\r\n|3|$FROM_NUMBERの最初一文字が+ではない|\r\n|4|$FROM_NUMBERの+以降が数値ではない|\r\n|5|$CALL_GROUP_ARRAY['グループ名']['REPEAT']の値が数値ではない|\r\n|6|$CALL_TIMEの値が数値ではない|\r\n|7|$SLEEP_TIMEの値が数値ではない|\r\n|8|$MESSAGE_REPEATの値が数値ではない|\r\n|9|$MESSAGESに含まれる$ARGVx$の数と引数の数(argv[0],argv[1]を除く)が一致しない|\r\n|10|$CALL_GROUP_ARRAY['グループ名']['NUMBER_LIST']の値が数値ではない|\r\n|11|$CALL_GROUP_ARRAY['グループ名']['NUMBER_LIST']の値が日本向けの電話番号ではない|\r\n\r\n\r\n### call-function.php\r\ncall-function.phpには、以下の関数が定義されています。関数に渡している引数については、下記の表を参照してください。\r\n\r\n|関数名|説明|\r\n|---|---|\r\n|twilio_call ($client, $GROUP_NAME, $CALL_COUNT, $FROM_NUMBER, $NUMBER_LIST_NUMBER, $twilioMessages, $CALL_TIME, $SLEEP_TIME, $ARGV_COUNT)|引数を元に、電話を掛ける処理を行う|\r\n|twilio_log ($client, $call, $GROUP_NAME, $CALL_COUNT, $SLEEP_TIME, $ARGV_COUNT)|電話を掛けた結果をログファイルに出力|\r\n|error_log_message($error_message)|ログファイルにエラー内容を書き込む|\r\n\r\n|引数名|説明|\r\n|---|---|\r\n|$client|TwilioのRESTクライアントをインスタンス化|\r\n|$GROUP_NAME|グループ名|\r\n|$CALL_COUNT|何順目のコール処理かのカウント|\r\n|$NUMBER_LIST_NUMBER|電話の宛先番号|\r\n|$twilioMessages|流すメッセージ内容|\r\n|$ARGV_COUNT|call-request.phpに渡された引数の数|\r\n|$call|コール処理のオブジェクト|\r\n|$error_message|エラーメッセージ|\r\n\r\n\r\n### twilio_zabbix.php\r\ntwilio_zabbix.phpは、call-request.phpにて使用するパラメータを設定しているファイルです。  \r\nパラメータを変更することで、連絡先電話番号や流すメッセージを設定できます。\r\n\r\n|パラメータ名|説明|\r\n|---|---|\r\n|$ACCOUNT_SID|TwilioアカウントのACCOUNT SID|\r\n|$AUTH_TOKEN|TwilioアカウントのAUTH_TOKEN|\r\n|$FROM_NUMBER|Twilioアカウントに紐づいたTwilioの電話番号|\r\n|$CALL_GROUP_ARRAY|グループ名毎に'REPEAT'に設定した回数だけ通話スクリーニングを実施する。 コール先は、'NUMBER_LIST'に設定した番号である。番号は\",(カンマ)\"区切りで複数設定できる。例を表下に記載する。|\r\n|$CALL_TIME|何秒間コールするか|\r\n|$SLEEP_TIME|電話の応答がなかった場合に次の電話番号にコールするまでの待機時間（秒）|\r\n|$MESSAGE_REPEAT|$MESSAGESの内容を流す回数|\r\n|$MESSAGES|電話応答があった場合に流すメッセージを設定。 引数の値をメッセージに含めたい場合は、置き換える部分に$ARGV2$,$ARGV3$のように置き換え文字列を設定する。置き換え文字列は'$ARGVx$'の形式で、'x'の部分は1からの連番を設定し、メッセージの中で同じ番号は使用できない。 メッセージ中で連続した数字\"10-1234-5678\"があった場合、発音が\"ジュウ センニヒャクサンジュウヨン ゴセンロッピャクナナジュウハチ\"となるので、句読点などを入れて分割する必要がある。|\r\n\r\n> 例）  \r\n$CALL_GROUP_ARRAY['group1']['REPEAT']='2';  \r\n$CALL_GROUP_ARRAY['group1']['NUMBER_LIST']='810123456789,811234567890';  \r\n$CALL_GROUP_ARRAY['group2']['REPEAT']='3';  \r\n$CALL_GROUP_ARRAY['group2']['NUMBER_LIST']='810123456789,811234567890';  \r\n> \r\n\r\n### calllog.log\r\ncalllog.logは、Twilioのコール結果や、引数確認等のエラー内容を下記の形式で書き込まれるログファイルです。\r\n> \r\nログ形式：  \r\n日時は、\"yyyy/mm/dd hh:mm:ss\"の書式で出力します。  \r\n・エラーの場合  \r\n発生日時 エラー内容  \r\n・Twilioのコール結果  \r\n発生日時 グループ名 FROM TO コール開始時間 コール終了時間 コールリトライ回数 コールステータス sleep_time call-request.phpが受け取った引数の数  \r\n> \r\n\r\n## ファイル設置場所\r\n各ファイルは、下記のように設置する必要があります。（ログファイルは、スクリプトを実行すると自動で作成されます。）\r\n\r\n|設置場所|ファイル名|\r\n|---|---|\r\n|/var/www/html/rest/|call-request.php、call-function.php、Serviceディレクトリ|\r\n|/var/lib/zabbix/|twilio_zabbix.php|\r\n|/var/log/zabbix/|calllog.log|\r\n\r\n## 動作確認環境\r\n* Zabbix 2.2.2\r\n* PHP 5.5.7\r\n\r\n## 実行方法\r\nZabbixから[設定]->[アクション]->[アクションの実行内容]にて、下記のようにcall-request.phpに引数として、\"グループ名\"、\"ホスト名\"、\"トリガー名\"を渡して実行するようにする。\r\n\r\n![zabbix01](https://github.com/d-watanabe/test/raw/master/zabbix1.PNG)\r\n\r\n\r\n```\r\n/usr/bin/php /var/www/html/rest/call-request.php \"group1\" \"{HOST.NAME1}\" \"{TRIGGER.NAME}\"\r\n```\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}