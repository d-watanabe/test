<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Test　Twilio_Zabbix : Test　Use Twilio in Zabbix" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Test　Twilio_Zabbix</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/d-watanabe/test">View on GitHub</a>

          <h1 id="project_title">Test　Twilio_Zabbix</h1>
          <h2 id="project_tagline">Test　Use Twilio in Zabbix</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/d-watanabe/test/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/d-watanabe/test/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="%E6%A6%82%E8%A6%81" class="anchor" href="#%E6%A6%82%E8%A6%81"><span class="octicon octicon-link"></span></a>概要</h1>

<hr><p>Zabbixと連携して、指定した連絡先に電話を掛けるものになります。<br>
これにより、Zabbixで障害を検知したら、自動で担当者へ障害が発生したことを電話で伝える事が可能になります。</p>

<h2>
<a name="%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E3%83%8E%E3%83%BC%E3%83%88" class="anchor" href="#%E3%83%AA%E3%83%AA%E3%83%BC%E3%82%B9%E3%83%8E%E3%83%BC%E3%83%88"><span class="octicon octicon-link"></span></a>リリースノート</h2>

<p>2014/mm/dd ver.1.0 公開  </p>

<hr><h2>
<a name="%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB" class="anchor" href="#%E4%BD%BF%E7%94%A8%E3%81%99%E3%82%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB"><span class="octicon octicon-link"></span></a>使用するファイル</h2>

<p>※config.phpが2つありますが、それぞれ別の場所に設置して使用します。</p>

<table>
<thead><tr>
<th>ファイル名</th>
<th>説明</th>
</tr></thead>
<tbody>
<tr>
<td>twilio-call.php</td>
<td>引数チェック及び電話を掛ける処理を実行する。</td>
</tr>
<tr>
<td>config.php</td>
<td>Twilioアカウント情報などが設定されている。</td>
</tr>
<tr>
<td>config.php</td>
<td>ZabbixAPIを使用するためのユーザ情報などが設定されている。</td>
</tr>
<tr>
<td>yyyymmdd.log</td>
<td>スクリプト実行時のログファイル。エラー内容や、宛先などの情報を記録する。</td>
</tr>
<tr>
<td>zabbix-twilio.php</td>
<td>TwilioのIVR処理を実行させる。</td>
</tr>
<tr>
<td>zabbix-twilio.php_yyyymmdd.log</td>
<td>スクリプト実行時のログファイル。Twilioのメッセージ内容や、宛先などの情報を記録する。</td>
</tr>
<tr>
<td>ZabbixApiAbstract.class.php</td>
<td>PhpZabbixApi library</td>
</tr>
<tr>
<td>ZabbixApi.class.php</td>
<td>PhpZabbixApi library</td>
</tr>
<tr>
<td>Twilio.php</td>
<td>Twilio API library</td>
</tr>
<tr>
<td>Twilioディレクトリ</td>
<td>Twilio API library(PHP)のディレクトリ。 公式ページからダウンロードする。 <a href="https://github.com/twilio/twilio-php/archive/latest.zip">Twilio API Library(PHP)</a>
</td>
</tr>
</tbody>
</table><h2>
<a name="%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E8%AA%AC%E6%98%8E" class="anchor" href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E8%AA%AC%E6%98%8E"><span class="octicon octicon-link"></span></a>ファイル説明</h2>

<h3>
<a name="twilio-callphp" class="anchor" href="#twilio-callphp"><span class="octicon octicon-link"></span></a>twilio-call.php</h3>

<p>渡された引数に誤りがないかチェックし、問題なければ電話を掛ける処理を実行します。</p>

<table>
<thead><tr>
<th>関数名</th>
<th>説明</th>
</tr></thead>
<tbody>
<tr>
<td>__construct</td>
<td>ログファイル作成を行う。</td>
</tr>
<tr>
<td>log</td>
<td>ログファイルへの出力処理を行う。</td>
</tr>
</tbody>
</table><table>
<thead><tr>
<th>EXIT番号</th>
<th>内容</th>
</tr></thead>
<tbody>
<tr>
<td>0</td>
<td>正常終了</td>
</tr>
<tr>
<td>1</td>
<td>info</td>
</tr>
<tr>
<td>2</td>
<td>エラー</td>
</tr>
</tbody>
</table><h3>
<a name="zabbix-twiliophp" class="anchor" href="#zabbix-twiliophp"><span class="octicon octicon-link"></span></a>zabbix-twilio.php</h3>

<p>このファイルで、ユーザーのキー操作を判定し、処理を分岐させています。<br>
処理の分岐は、初回のメッセージのときは、"キー 1"を押すと、ユーザーが対応できるという判断をし、Zabbixの該当のアラートに障害対応コメントを書き込み処理を終了します。<br>
次のユーザーがいた場合は、次のユーザーへ電話はかけません。<br>
その他のキーを押した場合は、再度入力を促すメッセージを流します。<br>
また、メッセージを流した後にしばらくキーの入力がなかった場合は、通話を切ります。  </p>

<p>なおこのファイルには、以下の関数が定義されています。</p>

<table>
<thead><tr>
<th>関数名</th>
<th>説明</th>
</tr></thead>
<tbody>
<tr>
<td>TwiML_notice</td>
<td>スクリプト実行時に初回に相手にメッセージを流す処理を行う。</td>
</tr>
<tr>
<td>TwiML_Register</td>
<td>Zabbixの障害対応コメントに対応した旨メッセージを記録する。</td>
</tr>
<tr>
<td>TwiML_Retype</td>
<td>キー操作を受付、初回メッセージ以外を相手に流す。</td>
</tr>
<tr>
<td>__construct</td>
<td>ログファイル作成を行う。</td>
</tr>
<tr>
<td>log</td>
<td>ログファイルへの出力処理を行う。</td>
</tr>
</tbody>
</table><table>
<thead><tr>
<th>EXIT番号</th>
<th>内容</th>
</tr></thead>
<tbody>
<tr>
<td>0</td>
<td>正常終了</td>
</tr>
<tr>
<td>1</td>
<td>エラー</td>
</tr>
</tbody>
</table><h3>
<a name="configphp" class="anchor" href="#configphp"><span class="octicon octicon-link"></span></a>config.php</h3>

<p>Twilioアカウント情報などが設定されています。</p>

<table>
<thead><tr>
<th>パラメータ名</th>
<th>説明</th>
</tr></thead>
<tbody>
<tr>
<td>$LOG_FILE</td>
<td>ログファイル出力先</td>
</tr>
<tr>
<td>$URL</td>
<td>Twilioサーバと通信を行う為の、外部公開されたWEBサーバに設置したスクリプトへのURL</td>
</tr>
<tr>
<td>$ZABBIX_API</td>
<td>ZabbixAPIのファイルパス</td>
</tr>
<tr>
<td>$ZABBIX_USER</td>
<td>Zabbixに登録されたユーザ名</td>
</tr>
<tr>
<td>$ZABBIX_PASS</td>
<td>Zabbixに登録されたユーザのパスワード</td>
</tr>
</tbody>
</table><h3>
<a name="configphp-1" class="anchor" href="#configphp-1"><span class="octicon octicon-link"></span></a>config.php</h3>

<p>ZabbixAPIを使用するためのユーザ情報などが設定されています。</p>

<table>
<thead><tr>
<th>パラメータ名</th>
<th>説明</th>
</tr></thead>
<tbody>
<tr>
<td>$LOG_FILE</td>
<td>ログファイル出力先</td>
</tr>
<tr>
<td>$URL</td>
<td>Twilioサーバと通信を行う為の、外部公開されたWEBサーバに設置したスクリプトへのURL</td>
</tr>
<tr>
<td>$ZABBIX_API</td>
<td>ZabbixAPIのファイルパス</td>
</tr>
<tr>
<td>$ZABBIX_USER</td>
<td>Zabbixに登録されたユーザ名</td>
</tr>
<tr>
<td>$ZABBIX_PASS</td>
<td>Zabbixに登録されたユーザのパスワード</td>
</tr>
</tbody>
</table><h3>
<a name="yyyymmddlog" class="anchor" href="#yyyymmddlog"><span class="octicon octicon-link"></span></a>yyyymmdd.log</h3>

<p>Twilioの電話処理結果や、エラー内容を下記の形式で書き込まれます。</p>

<blockquote>
<p>ログ形式：<br>
日時は、"yyyy/mm/dd hh:mm:ss"の書式で出力します。<br>
・エラーの場合<br>
発生日時 プロセスID エラー内容<br>
・処理が正常に行われた場合<br>
発生日時 プロセスID 宛先電話番号 ステータス  </p>
</blockquote>

<h3>
<a name="zabbix-twiliophp_yyyymmddlog" class="anchor" href="#zabbix-twiliophp_yyyymmddlog"><span class="octicon octicon-link"></span></a>zabbix-twilio.php_yyyymmdd.log</h3>

<p>Twilioの電話処理結果や、エラー内容を下記の形式で書き込まれます。</p>

<blockquote>
<p>ログ形式：<br>
日時は、"yyyy/mm/dd hh:mm:ss"の書式で出力します。<br>
・エラーの場合<br>
発生日時 プロセスID エラー内容<br>
・処理が正常に行われた場合<br>
発生日時 プロセスID Twilioの電話履歴の情報  </p>
</blockquote>

<h2>
<a name="%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E8%A8%AD%E7%BD%AE%E5%A0%B4%E6%89%80" class="anchor" href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E8%A8%AD%E7%BD%AE%E5%A0%B4%E6%89%80"><span class="octicon octicon-link"></span></a>ファイル設置場所</h2>

<p>各ファイルは、下記のように設置する必要があります。（ログファイルは、スクリプトを実行すると自動で作成されます。）</p>

<table>
<thead><tr>
<th>設置場所</th>
<th>ファイル名</th>
</tr></thead>
<tbody>
<tr>
<td>/usr/lib/zabbix/alertscripts/zabbix-twilio/</td>
<td>twilio-call.php、config.php</td>
</tr>
<tr>
<td>/usr/lib/zabbix/alertscripts/zabbix-twilio/logs/</td>
<td>yyyymmdd.log</td>
</tr>
<tr>
<td>/var/www/html/</td>
<td>zabbix-twilio.php、config.php</td>
</tr>
<tr>
<td>/var/www/html/logs/</td>
<td>zabbix-twilio.php_yyyymmdd.log</td>
</tr>
<tr>
<td>/usr/lib/zabbix/alertscripts/zabbix-twilio/lib/twilio/</td>
<td>Twilio.php、Twilioディレクトリ（Twilio API library）</td>
</tr>
<tr>
<td>/usr/lib/zabbix/alertscripts/zabbix-twilio/lib/PhpZabbixApi/</td>
<td>ZabbixApiAbstract.class.php、ZabbixApi.class.php</td>
</tr>
</tbody>
</table><h2>
<a name="%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D%E7%92%B0%E5%A2%83" class="anchor" href="#%E5%8B%95%E4%BD%9C%E7%A2%BA%E8%AA%8D%E7%92%B0%E5%A2%83"><span class="octicon octicon-link"></span></a>動作確認環境</h2>

<ul>
<li>Zabbix 2.2.2</li>
<li>PHP 5.3.3</li>
</ul><h2>
<a name="%E5%AE%9F%E8%A1%8C%E6%96%B9%E6%B3%95" class="anchor" href="#%E5%AE%9F%E8%A1%8C%E6%96%B9%E6%B3%95"><span class="octicon octicon-link"></span></a>実行方法</h2>

<p>1.新規メディアタイプを作成する。<br>
まずは、Twilioで電話を掛ける為に[メディアタイプ]を追加してください。  </p>

<p>[管理]&gt;[メディアタイプ]&gt;[メディアタイプの作成]  </p>

<p>[名前]：Twilio<br>
[タイプ]：スクリプト<br>
[スクリプト名]：zabbix-twilio/twilio-call.php  </p>

<hr><p>2.ユーザーにメディアタイプを追加する。<br>
[管理]&gt;[ユーザー]&gt;[ユーザー]<br>
ユーザーに、先ほど作成したメディア【tel】を追加してください。<br>
[送信先]をユーザーの電話番号を設定してください。<br>
今回は、担当者が3名いる想定で設定しています。</p>

<hr><p>3.アクションの設定を行う。<br>
[設定]&gt;[アクション]&gt;[アクションの作成]<br>
[アクションの作成]から、アクションの実行条件を指定し、<br>
[アクションの実行内容]で、画像のように設定してください。  </p>

<p>画像のようにステップを増やすことで、順番に電話を掛けることができます。  </p>

<p>実行内容は、[メッセージの送信]<br>
次のメディアのみ使用[tel]  </p>

<p>この状態で、障害を検知すると、User1-&gt;User2-&gt;User3の順番に電話を掛けます。<br>
下の画像の例では、User2が応答した例になっています。<br>
黒塗りしている部分は、User2の電話番号になります。  </p>

<hr><h4>
<a name="%E9%80%A3%E7%B5%A1%E5%85%88" class="anchor" href="#%E9%80%A3%E7%B5%A1%E5%85%88"><span class="octicon octicon-link"></span></a>連絡先</h4>

<p>mail : </p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Test　Twilio_Zabbix maintained by <a href="https://github.com/d-watanabe">d-watanabe</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
